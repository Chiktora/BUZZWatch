# BUZZWatch - Документация за Raspberry Pi

![Raspberry Pi](https://img.shields.io/badge/device-Raspberry%20Pi-red.svg)
![Python](https://img.shields.io/badge/python-3.6+-blue.svg)
![ThingSpeak](https://img.shields.io/badge/cloud-ThingSpeak-green.svg)

## Съдържание
1. [Системна архитектура](#системна-архитектура)
2. [Хардуерна настройка](#хардуерна-настройка)
3. [Софтуерни компоненти](#софтуерни-компоненти)
4. [Инсталационно ръководство](#инсталационно-ръководство)
5. [Конфигурация](#конфигурация)
6. [Работа на сензорите](#работа-на-сензорите)
7. [Поток на данните](#поток-на-данните)
8. [Калибриране на тегловна клетка с висока прецизност](#калибриране-на-тегловна-клетка-с-висока-прецизност)
9. [Интеграция с ThingSpeak](#интеграция-с-thingspeak)
10. [Тестване и отстраняване на неизправности](#тестване-и-отстраняване-на-неизправности)
11. [Обработка на грешки](#обработка-на-грешки)
12. [Референции](#референции)

## Системна архитектура

BUZZWatch следва структурирана многослойна архитектура, която разделя отговорностите в отделни компоненти:

```
BUZZWatch/
├── errors/                  # Съхранение на логове за грешки
├── venv/                    # Python виртуална среда
├── raspberry_pi_code/
│   ├── config.py            # Конфигурация на пиновете и настройки
│   ├── errors.py            # Функционалност за логване на грешки
│   ├── hardware_layer/      # Директна комуникация с хардуера
│   │   └── sensors.py       # Инициализация и четене на сензори
│   ├── data_collection_layer/ # Обработка и агрегиране на данни
│   │   └── data_collector.py  # Основна логика за събиране на данни
│   ├── services/            # Интеграция с външни услуги
│   │   └── api/
│   │       └── thingspeak.py # Комуникация с ThingSpeak API
│   ├── scripts/             # Входни точки
│   │   └── run_pi.py        # Основен стартов скрипт
│   └── tests/               # Инструменти за тестване
│       └── test_*.py        # Тестове на отделните компоненти
├── requirements.txt         # Python зависимости
├── start.sh                 # Стартов скрипт
└── README.md                # Проектна документация
```

Архитектурата следва ясно разделение на отговорностите:
- **Хардуерен слой**: Управлява директната комуникация със сензорите
- **Слой за събиране на данни**: Обработва и агрегира данни от сензорите
- **Сервизен слой**: Управлява комуникацията с външни API (ThingSpeak)
- **Скриптове**: Предоставя входни точки и инструменти за работа със системата
- **Конфигурация**: Централизира всички конфигурируеми параметри

## Хардуерна настройка

### Необходими компоненти
- **Raspberry Pi** (всеки модел с GPIO пинове)
- **DHT22 Сензори за температура и влажност** (2 броя)
- **HX711 Усилвател за тегловни клетки**
- **Тегловни клетки** (обикновено 4 броя за платформа за измерване)
- **Дървена платформа** (за поставяне върху тегловните клетки)

### Свързване на пиновете
1. **Вътрешен DHT22 сензор**:
   - Пин за данни: GPIO4
   - Захранване: 3.3V или 5V (проверете спецификациите на сензора)
   - Земя: GND

2. **Външен DHT22 сензор**:
   - Пин за данни: GPIO17
   - Захранване: 3.3V или 5V (проверете спецификациите на сензора)
   - Земя: GND

3. **HX711 Усилвател за тегловни клетки**:
   - DOUT: GPIO27
   - SCK (PD_SCK): GPIO22
   - Захранване: 3.3V или 5V (проверете спецификациите на HX711)
   - Земя: GND

4. **Тегловни клетки**:
   - Свържете към HX711 според документацията на усилвателя
   - Обикновено се свързват в конфигурация Уитстонов мост

### Схема на свързване

```
Raspberry Pi                DHT22 (Вътрешен)
+--------+                  +--------+
|      3V|------------------|VCC     |
|    GPIO4|-----------------|DATA    |
|     GND|------------------|GND     |
+--------+                  +--------+

Raspberry Pi                DHT22 (Външен)
+--------+                  +--------+
|      3V|------------------|VCC     |
|   GPIO17|-----------------|DATA    |
|     GND|------------------|GND     |
+--------+                  +--------+

Raspberry Pi                HX711
+--------+                  +--------+
|      5V|------------------|VCC     |
|   GPIO27|-----------------|DOUT    |
|   GPIO22|-----------------|SCK     |
|     GND|------------------|GND     |
+--------+                  +--------+
                                |
                          Тегловни клетки (4 бр.)
                          +-------------+
```

## Софтуерни компоненти

### 1. Хардуерен слой (`sensors.py`)
Отговаря за инициализирането и четенето на данни от физическите сензори:
- **DHT22 Сензори**: Измерва температура и влажност
- **HX711 Тегловни клетки**: Измерва тегло с висока прецизност
- Имплементира рутини за калибриране на HX711 сензора
- Обработва грешки и неуспешни инициализации на сензори

### 2. Слой за събиране на данни (`data_collector.py`)
Организира процеса на събиране на данни:
- Инициализира се с ThingSpeak API ключ
- Събира данни от всички сензори
- Конвертира теглото в килограми с 2 десетични знака за ThingSpeak
- Качва всички данни от сензорите в ThingSpeak
- Обработва грешки по време на процеса на събиране

### 3. Сервизен слой (`thingspeak.py`)
Управлява комуникацията с ThingSpeak API:
- Тества връзката с ThingSpeak
- Качва данни от сензорите в съответните полета
- Съпоставя данните с полетата на ThingSpeak (температура, влажност, тегло)
- Обработва API грешки и проблеми с връзката

### 4. Обработка на грешки (`errors.py`)
Предоставя централизирано логване на грешки:
- Записва грешки в JSON файл с времеви маркери
- Включва кодове за грешки и подробни съобщения
- Създава директория за логове на грешки, ако не съществува

### 5. Основно приложение (`run_pi.py`)
Входната точка за приложението:
- Инициализира колектора на данни
- Тества връзката с ThingSpeak
- Изпълнява се в непрекъснат цикъл, събира и качва данни
- Обработва изключения и прекъсвания

## Инсталационно ръководство

### Предварителни изисквания
- Raspberry Pi с инсталирана Raspberry Pi OS (Raspbian)
- Инсталиран Python 3.6 или по-висока версия
- Интернет връзка за качване на данни в ThingSpeak

### Стъпка 1: Инсталиране на системни зависимости
```bash
sudo apt-get update
sudo apt-get install -y python3-full python3-pip python3-dev python3-setuptools libgpiod2
```

### Стъпка 2: Клониране на хранилището
```bash
git clone https://github.com/Chiktora/BUZZWatch.git
cd BUZZWatch
```

### Стъпка 3: Настройка на виртуална среда (Препоръчително, но не задължително)
```bash
python3 -m venv venv
source venv/bin/activate
```

### Стъпка 4: Инсталиране на специфични библиотеки за сензорите
```bash
# Инсталиране на DHT22 библиотека
git clone https://github.com/adafruit/Adafruit_Python_DHT.git
cd Adafruit_Python_DHT
python setup.py install
cd ..

# Инсталиране на HX711 библиотека
git clone https://github.com/tatobari/HX711_Python.git
cd HX711_Python
python setup.py install
cd ..
```

### Стъпка 5: Инсталиране на Python зависимости
```bash
pip install -r requirements.txt
```

### Стъпка 6: Конфигуриране на системата
```bash
# Копиране на примерна конфигурация
cp raspberry_pi_code/config.py.example raspberry_pi_code/config.py

# Редактиране на конфигурационния файл с вашите настройки
nano raspberry_pi_code/config.py
```

### Стъпка 7: Настройка на ThingSpeak
1. Създайте акаунт в ThingSpeak на https://thingspeak.com
2. Създайте нов канал с 5 полета:
   - Поле 1: Вътрешна температура
   - Поле 2: Вътрешна влажност
   - Поле 3: Външна температура
   - Поле 4: Външна влажност
   - Поле 5: Тегло
3. Вземете вашия Write API ключ
4. Актуализирайте `THINGSPEAK_API_KEY` в `config.py`

### Стъпка 8: Подготовка на стартовия скрипт
```bash
cp start.sh.example start.sh
chmod +x start.sh
```

## Конфигурация

Системата се конфигурира чрез файла `config.py`, който включва:

### ThingSpeak конфигурация
```python
THINGSPEAK_API_KEY = "ВАШИЯТ_API_КЛЮЧ_ТУК"
```

### Конфигурация на пиновете
```python
# Конфигурация на сензорите
INDOOR_DHT22_PIN = 4    # GPIO4
OUTDOOR_DHT22_PIN = 17  # GPIO17
HX711_DOUT_PIN = 27     # GPIO27
HX711_SCK_PIN = 22      # GPIO22
```

### Настройки за събиране на данни
```python
# Конфигурация за събиране на данни
COLLECTION_INTERVAL = 60  # секунди
```

## Работа на сензорите

### DHT22 Сензори
Системата използва Adafruit CircuitPython DHT библиотека за четене на данни за температура и влажност:
- **Температурен диапазон**: -40°C до 80°C, ±0.5°C точност
- **Диапазон на влажност**: 0-100% RH, ±2-5% точност
- Всеки сензор се чете 5 пъти последователно, за да се осигурят надеждни данни
- Показанията се осредняват, за да се намали шумът

### HX711 Система за тегловни клетки
Системата за измерване на тегло използва HX711 24-битов АЦП с тегловни клетки:
- **Резолюция**: 24-бита
- **Множество показания**: Всяко измерване осреднява множество проби
- **Разширено калибриране**: Триетапен процес на калибриране с висока прецизност
- **Откриване на отклонения**: Статистическо филтриране на база IQR (метод 1.3×IQR)
- **Конвертиране на тегло**: Необработените стойности се конвертират в грамове или килограми според калибрирането

### Ключови функции

#### Температура и влажност
```python
def read_dht22_indoor():
    """
    Четене на температура/влажност от вътрешния сензор.
    Връща (temp_c, humidity) или (None, None) при грешка.
    """
    
def read_dht22_outdoor():
    """
    Четене на температура/влажност от външния сензор.
    Връща (temp_c, humidity) или (None, None) при грешка.
    """
```

#### Измерване на тегло
```python
def read_weight(return_kg=True):
    """
    Четене на тегло от HX711 сензор.
    Аргументи:
        return_kg: Ако е True, връща теглото в килограми, в противен случай в грамове
    Връща:
        Стойност на теглото или None при грешка.
    """
    
def read_weight_for_thingspeak():
    """
    Четене на тегло, форматирано за ThingSpeak (kg с 2 десетични знака).
    Връща:
        Тегло в kg или None при грешка.
    """
```

## Поток на данните

1. **Четене на сензори**:
   - DHT22 сензорите се четат за температура и влажност
   - HX711 тегловните клетки се четат за данни за тегло
   
2. **Обработка на данни**:
   - Показанията за температура и влажност се осредняват от множество проби
   - Показанията за тегло се филтрират за отклонения и се осредняват
   - Теглото се конвертира в kg с 2 десетични знака за ThingSpeak
   
3. **Качване на данни**:
   - Всички данни от сензорите се подготвят за ThingSpeak
   - Данните се изпращат чрез HTTP POST към ThingSpeak API
   - Отговорът се проверява за успешно качване
   
4. **Наблюдение и съхранение**:
   - ThingSpeak съхранява данните за визуализация и анализ
   - Локалната конзола показва текущите показания
   - Грешките се записват в локален лог файл

## Калибриране на тегловна клетка с висока прецизност

Системата включва разширена система за калибриране на HX711 тегловните клетки:

### Триетапен процес на калибриране
1. **Празна везна**: Измерва базова линия без нищо върху везната
2. **Тегло тара**: Измерва само с дървената платформа
3. **Референтно тегло**: Измерва с известно референтно тегло върху платформата

### Функции за калибриране
- **Висок брой проби**: Взема 150 измервания за всяка стъпка на калибриране
- **Статистически анализ**: Изчислява средна стойност, медиана, стандартно отклонение, CV%
- **Премахване на отклонения**: Използва метод 1.3×IQR за филтриране на аномални показания
- **Доверителни интервали**: Изчислява 95% доверителни интервали
- **Проследяване на прогреса**: Индикатори за прогрес на базата на партиди

### Изпълнение на калибриране
```bash
python raspberry_pi_code/tests/test_hx711.py
```

Това стартира интерактивния помощник за калибриране, който ще ви води през процеса:

1. Премахнете всички тежести от везната
2. Поставете само дървената платформа върху везната
3. Поставете референтното тегло (напр. 1kg) върху платформата
4. Въведете точната стойност на референтното тегло, когато бъдете подканени
5. Изчакайте процесът на калибриране да приключи
6. Тествайте точността на калибрирането

### Съхранение на калибрирането
- Данните за калибриране се съхраняват в JSON формат
- Местоположение на файла: `BUZZWatch/raspberry_pi_code/config/hx711_calibration.json`
- Включва подробни метаданни за справка:
  - Дата и час на калибриране
  - Използвано референтно тегло
  - Необработени стойности за всяка стъпка
  - Статистически мерки за стабилност

Примерен файл за калибриране:
```json
{
    "reference_unit": 2.248711,
    "zero_offset": -116261.13,
    "calibration_date": "2023-02-28 18:45:22",
    "known_weight_used": 1000.0,
    "empty_raw": -118263.45,
    "tare_raw": -116261.13,
    "weight_raw": -114012.42,
    "sensitivity": 2.248711,
    "tare_weight_raw_difference": 2002.32,
    "three_step_calibration": true,
    "measurements_per_step": 150,
    "empty_cv": 3.21,
    "tare_cv": 2.65,
    "weight_cv": 5.47,
    "calibration_precision": "high"
}
```

### Тестване на калибрирането
Системата тества качеството на калибрирането след завършване:
- Тества с поставена само платформата (трябва да показва близко до нула)
- Тества с референтно тегло (трябва да съответства на известното тегло)
- Изчислява процент на грешка и предоставя оценка на качеството

## Интеграция с ThingSpeak

ThingSpeak предоставя облачно съхранение и визуализация за данните от сензорите:

### Структура на данните
- **Поле 1**: Вътрешна температура (°C с 1 десетичен знак)
- **Поле 2**: Вътрешна влажност (% RH с 1 десетичен знак)
- **Поле 3**: Външна температура (°C с 1 десетичен знак)
- **Поле 4**: Външна влажност (% RH с 1 десетичен знак)
- **Поле 5**: Тегло (kg с 2 десетични знака)

### Процес на качване
1. Данните се събират от сензорите
2. Теглото се конвертира в kg с точно 2 десетични знака
3. Всички данни се качват в ThingSpeak веднъж на минута
4. Неуспешните качвания се логват и се опитват отново в следващия цикъл

### API комуникация
- Използва HTTPS POST заявки към ThingSpeak API
- Изисква валиден API Write ключ
- Тества връзката при стартиране
- Обработва плавно отказите на връзката

### Примерни данни
```
Вътрешни: 24.5°C, 45.2% RH
Външни: 18.3°C, 62.7% RH
Тегло: 42.55 kg
```

### Визуализация
В ThingSpeak можете да създадете:
- Графики с времеви редове на всички променливи
- Сравнителни графики (вътрешна срещу външна температура)
- Анализ на тенденциите в теглото
- Персонализирани изчисления и известия

## Тестване и отстраняване на неизправности

Системата включва всеобхватни инструменти за тестване:

### Компонентни тестове
```bash
# Тест на ThingSpeak връзката
python raspberry_pi_code/tests/test_thingspeak.py

# Тест на вътрешен DHT22
python raspberry_pi_code/tests/test_dht22_indoor.py

# Тест на външен DHT22
python raspberry_pi_code/tests/test_dht22_outdoor.py

# Тест на HX711 сензор за тегло
python raspberry_pi_code/tests/test_hx711.py
```

### Опции за тестване на HX711
```bash
# Стартиране на помощника за калибриране
python raspberry_pi_code/tests/test_hx711.py

# Режим на всеобхватно измерване
python raspberry_pi_code/tests/test_hx711.py --measure

# Тестване на теглото в реално време
python raspberry_pi_code/tests/test_hx711.py --test

# Преглед на информацията за калибриране
python raspberry_pi_code/tests/test_hx711.py --info
```

### Често срещани проблеми и решения

1. **Проблеми с четенето на DHT22**
   - **Симптоми**: Липсващи данни за температура или влажност
   - **Причини**: Проблеми с окабеляването, проблеми със захранването, смущения
   - **Решение**: Проверете окабеляването, осигурете стабилно захранване, опитайте се да преместите сензора далеч от източници на смущения

2. **Проблеми с четенето на HX711**
   - **Симптоми**: Нестабилни показания за тегло, грешки за изтичане на времето
   - **Причини**: Лошо калибриране, разхлабени връзки, фактори на околната среда
   - **Решение**: Повторно калибриране с използване на режим с висока прецизност, проверка на окабеляването, осигуряване на стабилна платформа

3. **Проблеми с връзката с ThingSpeak**
   - **Симптоми**: Съобщения за неуспешно качване, липсващи точки с данни
   - **Причини**: Проблеми с интернет връзката, проблеми с API ключа
   - **Решение**: Проверете интернет връзката, проверете дали API ключът е правилен

4. **Проблеми с калибрирането**
   - **Симптоми**: Непоследователни показания за тегло, високи проценти на грешка
   - **Причини**: Нестабилна платформа, вибрации, въздушни течения, температурни промени
   - **Решение**: 
     - Уверете се, че везната е на стабилна, равна повърхност
     - Дръжте далеч от вентилационни отвори или отворени прозорци
     - Поставете тегловните клетки на твърда, нееластична повърхност
     - Центрирайте внимателно платформата и тежестите

## Обработка на грешки

Системата използва структурирана система за логване на грешки:

### Логване на грешки
- Грешките се записват в `errors/errors.json`
- Всяка грешка включва:
  - Код на грешка (напр. "ERR_DHT22_INIT")
  - Подробно съобщение за грешка
  - Времеви маркер

### Често срещани кодове на грешки
- **ERR_DHT22_INIT**: Грешка при инициализиране на DHT22 сензорите
- **ERR_DHT22_INDOOR**: Грешка при четене от вътрешен DHT22
- **ERR_DHT22_OUTDOOR**: Грешка при четене от външен DHT22
- **ERR_HX711_INIT**: Грешка при инициализиране на HX711 сензор
- **ERR_HX711_CALIBRATION**: Грешка по време на процеса на калибриране
- **ERR_WEIGHT**: Грешка при четене на тегло от HX711
- **ERR_THINGSPEAK_TEST**: Грешка при тестване на връзката с ThingSpeak
- **ERR_THINGSPEAK_UPLOAD**: Грешка при качване на данни в ThingSpeak
- **ERR_DATA_COLLECTION**: Грешка в процеса на събиране на данни
- **ERR_MAIN**: Обща грешка в основното приложение

Примерен запис в лога на грешки:
```json
{
    "code": "ERR_HX711_CALIBRATION",
    "message": "Четенето от HX711 достигна таймаут след 3 секунди",
    "timestamp": "2023-02-28 17:42:15"
}
```

## Референции

### Ключови Python библиотеки
- **RPi.GPIO**: Контролира GPIO пиновете на Raspberry Pi
- **adafruit-circuitpython-dht**: Чете DHT22 сензори
- **hx711**: Интерфейс с HX711 усилвател за тегловни клетки
- **requests**: Управлява HTTP комуникациите с ThingSpeak
- **numpy**: Предоставя разширени статистически функции за анализ

### Местоположение на файловете
- **Конфигурация**: `raspberry_pi_code/config.py`
- **Данни за калибриране**: `raspberry_pi_code/config/hx711_calibration.json`
- **Логове за грешки**: `errors/errors.json`
- **Основен скрипт**: `raspberry_pi_code/scripts/run_pi.py`

### Изпълнение
За да стартирате системата BUZZWatch:
```bash
./start.sh
```

Това ще стартира системата на преден план. За производствено разгръщане, обмислете използването на мениджър на услуги като systemd, за да поддържате приложението в непрекъснато изпълнение и да го рестартирате автоматично, ако се срине.

### Настройка като услуга
За да настроите BUZZWatch като systemd услуга:

1. Създайте файл за услуга:
```bash
sudo nano /etc/systemd/system/buzzwatch.service
```

2. Добавете следното съдържание:
```
[Unit]
Description=BUZZWatch Система за наблюдение на пчелни кошери
After=network.target

[Service]
ExecStart=/home/pi/BUZZWatch/start.sh
WorkingDirectory=/home/pi/BUZZWatch
StandardOutput=inherit
StandardError=inherit
Restart=always
User=pi

[Install]
WantedBy=multi-user.target
```

3. Активирайте и стартирайте услугата:
```bash
sudo systemctl enable buzzwatch.service
sudo systemctl start buzzwatch.service
```

4. Проверете статуса:
```bash
sudo systemctl status buzzwatch.service
```

### Задачи за поддръжка

#### Периодично калибриране
Препоръчително е да калибрирате отново тегловните клетки:
- Поне веднъж месечно
- Всеки път, когато везната бъде преместена
- Ако температурните условия се променят значително
- Ако показанията започнат да се отклоняват или показват непоследователност

#### Системни актуализации
За да актуализирате системата BUZZWatch:
```bash
cd /home/pi/BUZZWatch
git pull
source venv/bin/activate
pip install -r requirements.txt
sudo systemctl restart buzzwatch.service
```

#### Архивиране на данните за калибриране
Периодично архивирайте вашия файл за калибриране:
```bash
cp /home/pi/BUZZWatch/raspberry_pi_code/config/hx711_calibration.json /home/pi/hx711_calibration_backup_$(date +%Y%m%d).json
```

---

**Създадено:** Март 2023  
**Последна актуализация:** Май 2023

За повече информация, посетете [GitHub хранилището](https://github.com/Chiktora/BUZZWatch) 